# Development Docker Compose with hot-reload
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: naviagent-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-naviagent_dev}
      POSTGRES_DB: naviagent_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    networks:
      - naviagent-dev-network

  # Main API Service (Development with hot-reload)
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: naviagent-api-dev
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-naviagent_dev}@postgres:5432/naviagent_dev
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      NAVIAGENT_API_PORT: 8000
      DEBUG: "True"
      ALLOW_ORIGINS: "*"
    ports:
      - "8000:8000"
    depends_on:
      - postgres
    networks:
      - naviagent-dev-network
    volumes:
      - ./src/naviagent:/app/src/naviagent
      - ./requirements-api.txt:/app/requirements-api.txt
    command: uvicorn src.naviagent.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # Reception Service (Development)
  reception:
    build:
      context: .
      dockerfile: Dockerfile.reception
    container_name: naviagent-reception-dev
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-naviagent_dev}@postgres:5432/naviagent_dev
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RECEPTIONIST_API_PORT: 8002
      DEBUG: "True"
      ALLOW_ORIGINS: "*"
    ports:
      - "8002:8002"
    depends_on:
      - postgres
    networks:
      - naviagent-dev-network
    volumes:
      - ./src/reception:/app/src/reception
      - chromadb_dev_data:/app/chromadb_data
    command: uvicorn src.reception.main:app --host 0.0.0.0 --port 8002 --reload
    restart: unless-stopped

  # Travel Planner Service (Development)
  planner:
    build:
      context: .
      dockerfile: Dockerfile.planner
    container_name: naviagent-planner-dev
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-naviagent_dev}@postgres:5432/naviagent_dev
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      WEATHERAPI_KEY: ${WEATHERAPI_KEY}
      RAPIDAPI_KEY: ${RAPIDAPI_KEY}
      TRIPADVISOR_API_KEY: ${TRIPADVISOR_API_KEY}
      TRAVEL_PLANNER_API_PORT: 8003
      DEBUG: "True"
      ALLOW_ORIGINS: "*"
    ports:
      - "8003:8003"
    depends_on:
      - postgres
    networks:
      - naviagent-dev-network
    volumes:
      - ./src/travel_planner:/app/src/travel_planner
    command: uvicorn src.travel_planner.main:app --host 0.0.0.0 --port 8003 --reload
    restart: unless-stopped

  # Frontend (Development with hot-reload)
  frontend:
    image: node:18-alpine
    container_name: naviagent-frontend-dev
    working_dir: /app
    environment:
      NEXT_PUBLIC_NAVIAGENT_API_URL: http://localhost:8000
      NEXT_PUBLIC_RECEPTION_API_URL: http://localhost:8002
      NEXT_PUBLIC_TRAVEL_PLANNER_API_URL: http://localhost:8003
    ports:
      - "3000:3000"
    depends_on:
      - api
      - reception
      - planner
    networks:
      - naviagent-dev-network
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    command: sh -c "npm install && npm run dev"
    restart: unless-stopped

volumes:
  postgres_dev_data:
    driver: local
  chromadb_dev_data:
    driver: local

networks:
  naviagent-dev-network:
    driver: bridge
